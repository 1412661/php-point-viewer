<?php/*	Đây là file hỗ trợ download điểm dưới dạng file excel đã được lưu trữ sẵn khi người quản lí website cập nhật điểm bằng file Excel*/include_once('config/config.php');include_once('function/function.php');error_reporting(E_ERROR | E_WARNING | E_PARSE);include_once('class/mysql.php');$sql = new MySQL();save_user_ip();$allowed_ext = array('xls', 'csv');##############################################################################################################################################################################// Hotlinking blockerif ((DOWNLOAD_ALLOW_REFERRER !== null) and (!isset($_SERVER['HTTP_REFERER']) or strpos(strtoupper($_SERVER['HTTP_REFERER']), strtoupper(DOWNLOAD_ALLOW_REFERRER)) === false)) {	page_view(true, false, true);	die();} elseif (!var_set($_GET['file'])) {	page_view(true, false, true);	die('<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/></head><body>Xin hãy cung cấp tên file bạn muốn download qua biến "file".</body></html>');} elseif (strpos($_GET['file'], "\0") !== false) {	page_view(true, false, true);	die();}// Get file name.$fname = basename($_GET['file']);if (($fname == 'readme.txt') or ($fname == 'index.html')) {	die('Access denied');}// get full file path (including subfolders)$file_path = null;find_file(UPLOAD_FOLDER, $fname, $file_path);if (!is_file($file_path)) {	page_view(true, false, true);	die('<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/></head><body>File không tồn tại, xin bạn vui lòng kiểm tra lại tên file hoặc liên hệ người quản lí để được hỗ trợ.</body></html>');}// get file extension$f_ext = strtolower(end(explode('.', $fname)));// check if extension is allowedif (!array_key_exists($f_ext, $allowed_ext)) {	page_view(true, false, true);	die('<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/></head><body>Hệ thống không cho phép bạn download loại file này, xin vui lòng liên hệ người quản lí để được hỗ trợ</body></html>'); }// get mime typeif ($allowed_ext[$f_ext] == null) {	$mtype = null;	// if mime type is not set, get from server settings	if (function_exists('mime_content_type')) {		$mtype = mime_content_type($file_path);	} elseif (function_exists('finfo_file')) {		$finfo = finfo_open(FILEINFO_MIME);		// return mime type		$mtype = finfo_file($finfo, $file_path);		finfo_close($finfo);  		}  	if ($mtype == null) {		$mtype = 'application/force-download';	}} else {	$mtype = $allowed_ext[$f_ext];	// get mime type defined by admin}// Download with custom file nameif ((isset($_GET['rename'])) or (!empty($_GET['rename']))) {	if ($_GET['rename'] == null) {		$fname = 'data.dat';	} else {		$fname = clear_invalid_fname($_GET['rename']);	}		page_view(true, true, true);}// Save log$sql->log('FILE DOWNLOAD', 'Tên file: ['.$fname.'], Kích thước: ['.filesize($file_path).' KB]');// Set headersheader('Pragma: public');header('Expires: 0');header('Cache-Control: must-revalidate, post-check = 0, pre-check = 0');header('Cache-Control: public');header('Content-Description: File Transfer');header('Content-Type: '.$mtype);header('Content-Disposition: attachment; filename="'.$fname.'"');header('Content-Transfer-Encoding: binary');header('Content-Length: '.filesize($file_path));/*// File Transfering$file = fopen($file_path, 'rb');if ($file) {	while(!feof($file)) {		print(fread($file, 1024*8));		flush();				if (connection_status() != 0) {			break;		}	}}*/####################################################		New File Transfering		####################################################echo file_get_contents($file_path);#########################       FUNCTION      #####################################// Check if file exists include checking in subfoldersfunction find_file($dirname, $fname, &$file_path) {	$dir = opendir($dirname);	while ($file = readdir($dir)) {		if (empty($file_path) and $file != '.' and $file != '..') {			if (is_dir($dirname.$file)) {				find_file($dirname.$file, $fname, $file_path);			} elseif (file_exists($dirname.$fname)) {				$file_path = $dirname.$fname;				return;			}		}	}}?>