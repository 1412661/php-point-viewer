<?php/*	Đây là file hiển thị bản ghi lịch sử các hoạt động tương tác của người dùng và hoạt động của người quản lí website. Nói một cách ngắn gọn, nó hiển thị quá trình sử dụng website của người dùng và người quản lí.*/
session_start();include_once('config/config.php');include_once('function/function.php');include_once('class/xtemplate/xtemplate.class.php');include_once('class/mysql.php');if (!RUNTIME_DEV_MODE) {	error_reporting(E_ERROR | E_WARNING | E_PARSE);}$sql = new MySQL();save_user_ip();if ($_SESSION['login'] <> true) {	$_SESSION['login'] = false;	outpage('Bạn phải đăng nhập mới được sử dụng chức năng này !');}if (RUNTIME_MOBILE_DETECT) {	$tpl = new XTemplate('template/mobile/log.tpl');} else {	$tpl = new XTemplate('template/log.tpl');}if (!is_array($_GET['action'])) {	$action = array();} else {	$action = $_GET['action'];}if (in_array('c_access', $action)) {	reset_count();	$sql->log('CLEAR LOG', 'Reset thống kê truy cập website, Tài khoản ['.$_SESSION['user'].']');	$tpl->assign('mess1', 'alert(\'Đã reset lại Thống kê truy cập\');');	$tpl->assign('checked_c_access', 'checked');}if (in_array('c_ip', $action)) {	$sql->setquery('TRUNCATE log_ip');		$sql->log('CLEAR LOG', 'Xóa toàn bộ thống kê IP, Tài khoản: ['.$_SESSION['user'].']');	$tpl->assign('mess2', 'alert(\'Đã xóa toàn bộ Thống kê IP\');');	$tpl->assign('checked_c_ip', 'checked');}if (in_array('c_log', $action)) {	$sql->setquery('TRUNCATE log');		$sql->log('CLEAR LOG', 'Xóa toàn bộ lịch sử sử dụng, Tài khoản: ['.$_SESSION['user'].']');	$tpl->assign('mess3', 'alert(\'Đã xóa toàn bộ Lịch sử sử dụng website\');');	$tpl->assign('checked_c_log', 'checked');}$tpl->assign('count_log', mysql_num_rows($sql->setquery('SELECT `id` FROM `log`')));$tpl->assign('count_ip', mysql_num_rows($sql->setquery('SELECT `id` FROM `log_ip`')));$tpl->assign('refresh', 'http://'.$_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI']);	if (in_array('access', $action)) {	show_site_access();	$tpl->assign('checked_access', 'checked');}if (in_array('ip', $action)) {	show_ip();	$tpl->assign('checked_ip', 'checked');}if (in_array('log', $action)) {	show_log();	$tpl->assign('checked_log', 'checked');}$sql->close();$tpl->parse('main.select');$tpl->parse('main');$tpl->out('main');
///////		sub function		/////////////////////////////////function show_log() {	global $tpl, $sql;		$search = $sql->setquery('SELECT * FROM `log` ORDER BY `id`');		if (mysql_num_rows($search) == 0) {		$tpl->parse('main.log.log_not_exist');	} else {		while ($data = mysql_fetch_assoc($search)) {			$tpl->set_autoreset();						$tpl->assign('id', $data['id']);			$tpl->assign('act', $data['act']);			$tpl->assign('act_info', $data['act_info']);			$tpl->assign('ip', $data['ip']);			$tpl->assign('time', $data['time']);						$tpl->parse('main.log.log_site');		}	}		$tpl->parse('main.log');}
function show_site_access() {
	global $tpl;	
	$tpl->assign('count_access', show_count('access'));	$tpl->assign('count_view', show_count('view'));	$tpl->assign('count_error', show_count('error'));		$tpl->parse('main.site_access');}//reset: reset_count();function show_ip() {	global $tpl, $sql;		$search = $sql->setquery('SELECT ip,time FROM log_ip');		$tpl->assign('count_ip', mysql_num_rows($search));	$tpl->assign('admin_ip', get_user_ip());		$stt = 0;	while ($data = mysql_fetch_assoc($search)) {		$tpl->set_autoreset();		$stt++;				$tpl->assign('stt', $stt);		$tpl->assign('ip', $data['ip']);		$tpl->assign('time', $data['time']);		$tpl->parse('main.log_ip.ip_detail');	}	$tpl->parse('main.log_ip');}
?>