<?php/*	Đây là file cung cấp chức năng tìm và xem điểm - một trong những chức năng chủ đạo của website*/session_start();include_once('config/config.php');include_once('function/function.php');include_once('function/func_xemdiem.php');include_once('class/mysql.php');include_once('class/xtemplate/xtemplate.class.php');if (!RUNTIME_DEV_MODE) {	error_reporting(E_ERROR | E_WARNING | E_PARSE);}$sql = new MySQL();save_user_ip();if (RUNTIME_MOBILE_DETECT) {	$tpl = new XTemplate('template/mobile/trangchu.tpl');} else {	$tpl = new XTemplate('template/trangchu.tpl');}// Nếu gọi file xemdiem.php mà không gửi dữ liệu lên -> chuyển hướng truy cập ra trang chủif (count($_GET) == 0) {	page_view(true, false, true);	$_SESSION['error'] = null;	header('location: index.php');}//check data/* Security: prevent XSS ****************************************http://localhost/xemdiem.php?db_id=143&search_method=');alert('fuck%20you*/if ((($_GET['search_method'] <> 'sbd') and ($_GET['search_method'] <> 'hs') and ($_GET['search_method'] <> 'class')) and (var_set($_GET['db_id'])) and (var_set($_GET['search_method']))) {	outpage('[search method] không hợp lệ !');}/*****************************************************************/$db_id = $_GET['db_id'];if (!var_set($db_id)) {	outpage('Bạn chưa nhập ID của cơ sở dữ liệu !', 'input(\'input_'.$_GET['search_method'].'\');');} elseif (!is_number($db_id)) {	outpage('ID của cơ sở dữ liệu phải là số nguyên !', 'input(\'input_'.$_GET['search_method'].'\');');} elseif (mysql_num_rows($sql->setquery('SELECT `id` FROM `db_info` WHERE `id` = '.$db_id)) == 0) {	outpage('Không tìm thấy cơ sở dữ liệu có ID là '.$db_id.'\nVui lòng kiểm tra lại danh sách cơ sở dữ liệu', 'input(\'input_'.$_GET['search_method'].'\');');}$search_method = $_GET['search_method'];if (!var_set($search_method)) {	outpage('Bạn chưa chọn kiểu tìm kiếm !');} else {	switch($search_method) {		case 'sbd':			$sbd = $_GET['hsname'];			if (!var_set($sbd)) {				outpage('Bạn chưa nhập số báo danh của học sinh !', 'input(\'input_sbd\');');			} elseif (!is_number($sbd)) {				outpage('Số báo danh của học sinh phải là số nguyên !', 'input(\'input_sbd\');');			}						$search = $sql->setquery('SELECT * FROM `database_'.$db_id.'` WHERE `sbd` = '.$sbd);						if (mysql_num_rows($search) == 0) {				outpage('Không tìm thấy học sinh có số báo danh ['.$sbd.'] trong cơ sở dữ liệu !');			} else {				//export data for sbd				page_view(true, true, false);				$sql->log('VIEW POINT', 'Database ID: ['.$db_id.'], Tìm kiếm theo số báo danh: ['.$sbd.']');				$tpl = RUNTIME_MOBILE_DETECT ? new XTemplate('template/mobile/output.tpl') : new XTemplate('template/output.tpl');				$db_info = mysql_fetch_assoc($sql->setquery('SELECT `name`, `year`, `subject`, `comment` FROM `db_info` WHERE `id` = '.$db_id));				$result = array(mysql_fetch_row($search));								export_hs($result, $db_info);			}					break;		case 'hs':			$hsname = $_GET['hsname'];			$class = $_GET['class'];						if (!var_set($hsname)) {				outpage('Bạn chưa nhập tên học sinh !', 'input(\'input_hs\')');			} elseif (!var_set($class)) {				outpage('Bạn chưa nhập lớp cho học sinh !', 'input(\'input_hs\')');			}			$search = $sql->setquery('SELECT * FROM `database_'.$db_id.'` WHERE `hsname` LIKE \'%'.$hsname.'\' AND `class` = \''.$class.'\'');						$count_hs = mysql_num_rows($search);						if ($count_hs == 0) {				outpage('Không tìm thấy học sinh có tên ['.standard_name($hsname).'] ở lớp ['.$class.'] trong cơ sở dữ liệu !', 'input(\'input_hs\')');			} else {				//export data for hs				page_view(true, true, false);				$sql->log('VIEW POINT', 'Database ID: ['.$db_id.'], Xem điểm của học sinh, Tên: ['.$hsname.'], Lớp: ['.$class.'], Số học sinh tìm được: ['.$count_hs.']');				$tpl = RUNTIME_MOBILE_DETECT ? new XTemplate('template/mobile/output.tpl') : new XTemplate('template/output.tpl');				$db_info = mysql_fetch_assoc($sql->setquery("SELECT name,year,subject,comment FROM db_info WHERE id='$db_id'"));							$result = array();				while ($result_ = mysql_fetch_row($search)) {					$result[] = $result_;				}				export_hs($result, $db_info);			}						break;		case 'class':			$class = $_GET['class'];			if (!var_set($class)) {				outpage('Bạn chưa nhập lớp !', 'input(\'input_class\')');			}						$search = $sql->setquery('SELECT * FROM `database_'.$db_id.'` WHERE `class` = \''.$class.'\'');						if (mysql_num_rows($search) == 0) {				outpage('Không tìm thấy lớp ['.$class.'] trong cơ sở dữ liệu !', 'input(\'input_class\')');			} else {				//export data for class				page_view(true, true, false);				$sql->log('VIEW POINT', 'Database ID: ['.$db_id.'], Xem điểm của lớp ['.$class.']');				$tpl = RUNTIME_MOBILE_DETECT ? new XTemplate('template/mobile/output.tpl') : new XTemplate('template/output.tpl');				$db_info = mysql_fetch_assoc($sql->setquery('SELECT `name`, `year`, `subject`, `comment` FROM `db_info` WHERE `id` = '.$db_id));				$result = array();				while ($result_ = mysql_fetch_row($search)) {					$result[] = $result_;				}									export_class($result, $db_info);			}				break;		default: outpage('Kiểu tìm kiếm không hợp lệ');	}}$sql->close();define('TIME_END', microtime(true));$sec =	round(TIME_END-TIME_START, 4);	$tpl->assign('sec', $sec);$tpl->assign('current_date', current_date());$tpl->parse('main');$tpl->out('main');?>