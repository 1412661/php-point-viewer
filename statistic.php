<?php/*	Đây là file cung cấp chức năng Phân tích điểm.*/
session_start();include_once('config/config.php');include_once('function/function.php');include_once('function/func_statistic.php');include_once('class/xtemplate/xtemplate.class.php');include_once('class/mysql.php');if (!RUNTIME_DEV_MODE) {	error_reporting(E_ERROR | E_WARNING | E_PARSE);}$sql = new MySQL();save_user_ip();if (RUNTIME_MOBILE_DETECT) {	$tpl = new XTemplate('template/mobile/trangchu.tpl');} else {	$tpl = new XTemplate('template/trangchu.tpl');}$db_id = $_GET['db_id'];if (!var_set($db_id)) {	outpage('Bạn chưa nhập ID cơ sở dữ liệu !');} else {	$search = $sql->setquery('SELECT * FROM `db_info` WHERE `id` = '.$db_id);	if (mysql_num_rows($search) == 0) {		outpage('Không tồn tại cơ sở dữ liệu có ID là ['.$db_id.']\nVui lòng xem lại danh sách cơ sở dữ liệu !');	}}$bxh_number = $_GET['bxh'];if ($bxh_number <> null) {	if (!is_number($bxh)) {		outpage('Kích thước bảng xếp hạng phải là số nguyên !');	} elseif ($bxh_number < 15) {		outpage('Kích thước bảng tối thiểu là 15 !');	} else {		$max_db = mysql_num_rows($sql->setquery('SELECT `sbd` FROM `database_'.$db_id.'`'));		if ($bxh_number > $max_db) {			outpage('Kích thước bảng xếp hạng tối đa là ['.$max_db.'] !');		}	}} else {	$bxh_number = 15;}page_view(true, true, false);$list_class = list_class($db_id);$db_info = mysql_fetch_assoc($search);//Import DB name$tpl->assign('db_name', $db_info['name'].' '.$db_info['comment'].' năm học '.$db_info['year']);$subject_arr = explode('|', $db_info['subject']);##########	Calculate avg point		################################$avg = 0;$sid_arr = unserialize(SUBJECT);for ($i = 0; $i <= (count($subject_arr)-1); $i++) {	$sid = 'sid'.$sid_arr[$subject_arr[$i]];	$avg_point = mysql_fetch_row($sql->setquery("SELECT AVG($sid) AS avg FROM database_$db_id WHERE $sid<>0"));	$avg = $avg + $avg_point[0];}$avg = number_format($avg/count($subject_arr), 4);$tpl->assign('avg_point', $avg);//////////////////////////////////////////////////////////////////////////////////////////Marquee_text$tpl->assign('marquee_text', NOTICE_MARQUEE);//subject_linkfor ($i = 0; $i <= (count($subject_arr)-1); $i++) {	$tpl->set_autoreset();	$tpl->assign('sid', $i+1);	$tpl->assign('subject', $subject_arr[$i]);	$tpl->parse('main.view_statistic.subject_link');}//Global pointfor ($i = 0; $i <= (count($list_class)-1); $i++) {	$tpl->set_autoreset();	$point = global_point($list_class[$i]);		$tpl->assign('global_class', $list_class[$i]);	$tpl->assign('link_global_class', 'xemdiem.php?db_id='.$db_id.'&amp;class='.$list_class[$i].'&amp;search_method=class');		$tpl->assign('global_count_hs', $point['count_hs']);			$tpl->assign('global_percent1', $point['percent']['per_5p']);	$tpl->assign('global_percent2', $point['percent']['per_5to65p']);	$tpl->assign('global_percent3', $point['percent']['per_65to8p']);	$tpl->assign('global_percent4', $point['percent']['per_8to10p']);	$tpl->assign('global_percent5', $point['percent']['per_10p']);			$tpl->assign('global_point1', $point['count_point']['count_5p']);	$tpl->assign('global_point2', $point['count_point']['count_5to65p']);	$tpl->assign('global_point3', $point['count_point']['count_65to8']);	$tpl->assign('global_point4', $point['count_point']['count_8to10p']);	$tpl->assign('global_point5', $point['count_point']['count_10p']);	$tpl->assign('global_pointtb', number_format($point['count_point']['dtb'], 3));	$tpl->assign('global_dlc', number_format($point['count_point']['dlc'], 4));	$tpl->assign('global_phsai', number_format($point['count_point']['phsai'], 4));			$tpl->parse('main.view_statistic.global_point');}
//	Point each subjectfor ($i = 0; $i<= (count($subject_arr)-1); $i++) {		//subject loop	$tpl->set_autoreset();		$tpl->assign('tid', $i+1);	$tpl->assign('subject', $subject_arr[$i]);		for ($k = 0; $k <= count($list_class)-1; $k++) {			//class loop		$tpl->set_autoreset();				$point = subject_point($list_class[$k], $sid_arr[$subject_arr[$i]]);				$tpl->assign('tabs_subject', $subject_arr[$i]);		$tpl->assign('tabs_class', $list_class[$k]);		$tpl->assign('link_tabs_class', 'xemdiem.php?db_id='.$db_id.'&amp;class='.$list_class[$k].'&amp;search_method=class');				$tpl->assign('tabs_count_hs', $point['count_hs']);				$tpl->assign('tabs_percent1', $point['percent']['per_5p']);		$tpl->assign('tabs_percent2', $point['percent']['per_5to65p']);		$tpl->assign('tabs_percent3', $point['percent']['per_65to8p']);		$tpl->assign('tabs_percent4', $point['percent']['per_8to10p']);		$tpl->assign('tabs_percent5', $point['percent']['per_10p']);				$tpl->assign('tabs_point1', $point['count_point']['count_5p']);		$tpl->assign('tabs_point2', $point['count_point']['count_5to65p']);		$tpl->assign('tabs_point3', $point['count_point']['count_65to8']);		$tpl->assign('tabs_point4', $point['count_point']['count_8to10p']);		$tpl->assign('tabs_point5', $point['count_point']['count_10p']);		$tpl->assign('tabs_pointtb', number_format($point['count_point']['dtb'], 3));		$tpl->assign('tabs_dlc', number_format($point['count_point']['dlc'], 4));		$tpl->assign('tabs_phsai', number_format($point['count_point']['phsai'], 4));				$tpl->parse('main.view_statistic.tabs.tabs_point');			}	$tpl->parse('main.view_statistic.tabs');}$tpl->assign('bxh_number', $bxh_number);$top_hs = top_hs($bxh_number);$hs_list = hs_list();				//consist of sbd (arr key) and hsname (arr value)//top first$rank = 1;foreach ($top_hs['first'] as $sbd => $point) {	$tpl->set_autoreset();		$tpl->assign('top_first_hsname', $hs_list[$sbd]['name']);	$tpl->assign('top_first_class', $hs_list[$sbd]['class']);	$tpl->assign('top_first_hspoint', number_format($point, 3));	$tpl->assign('top_first_rank', $rank);	$rank++;	$tpl->assign('top_first_sbd', $sbd);	$tpl->assign('db_id', $db_id);		$tpl->parse('main.view_statistic.top_first');}//top last$rank = 1;foreach ($top_hs['last'] as $sbd => $point) {	$tpl->set_autoreset();		$tpl->assign('top_last_hsname', $hs_list[$sbd]['name']);	$tpl->assign('top_last_class', $hs_list[$sbd]['class']);	$tpl->assign('top_last_hspoint', number_format($point, 3));	$tpl->assign('top_last_rank', $rank);	$rank++;	$tpl->assign('top_last_sbd', $sbd);	$tpl->assign('db_id', $db_id);		$tpl->parse('main.view_statistic.top_last');}$sql->log('VIEW STATISTIC', 'Database ID: ['.$db_id.']');$sql->close();// count and notice$tpl->assign('access', show_count('access'));$tpl->assign('view', show_count('view'));$tpl->assign('error', show_count('error'));$tpl->assign('notice_right', NOTICE_RIGHT_BOX);$tpl->assign('dynamic_title', '- Phân tích điểm số: '.$db_info['name'].' ['.$db_info['comment'].'] năm học '.$db_info['year']);$tpl->assign('fb_link', SITE.'link.php?link='.base64_encode($_SERVER['REQUEST_URI']));$tpl->assign('fb_title', 'PHPPV - Phân tích điểm số');$tpl->assign('fb_descr', 'Cơ sở dữ liệu: '.$db_info['name'].' ['.$db_info['comment'].'] năm học '.$db_info['year']);		$tpl->parse('main.view_statistic');define('TIME_END', microtime(true));$sec =	round(TIME_END-TIME_START, 4);	$tpl->assign('sec', $sec);$tpl->assign('current_date', current_date());$tpl->parse('main');$tpl->out('main');
?>