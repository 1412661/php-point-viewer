<?phpfunction get_db_list($year) {	global $sql;		$search = $sql->setquery('SELECT `id` FROM `db_info` WHERE `year` = \''.$year.'\'');	while ($db_id = mysql_fetch_row($search)) {		$db_list[] = $db_id[0];	}		return $db_list;}function get_db_info($db_id) {	global $sql;	$db_info = null;	$search = $sql->setquery('SELECT `name`,`comment` FROM `db_info` WHERE `id` = '.$db_id);		if (mysql_num_rows($search) == 0) {		return false;	} else {		$result = mysql_fetch_assoc($search);		$db_info = $result['name'].' ['.$result['comment'].']';				return $db_info;	}}function get_dtb($db_id, $sbd, $hsname, $class) {	global $sql;		$search = $sql->setquery('SELECT `subject` FROM `db_info` WHERE id = '.$db_id);	$subject = mysql_fetch_assoc($search);		$count_subject = substr_count($subject['subject'], '|') + 1;		$search = $sql->setquery('SELECT * FROM `database_'.$db_id.'` WHERE `sbd` = '.$sbd.' AND `hsname` LIKE \'%'.$hsname.'\' AND `class` = \''.$class.'\'');		if (mysql_num_rows($search) <> 0) {		$hs = mysql_fetch_assoc($search); 				$point = 0;						foreach ($hs as $hs_info => $val) {			if (strpos($hs_info, 'sid') === 0) {				$point = $point + $val;			}		}		return number_format($point / $count_subject, 2);	} else {		return false;	}}function export_hs($sbd, $hsname, $class) {	global $sql, $tpl, $db_list, $year;	$stt = 0;	foreach ($db_list as $db_id) {		if (mysql_num_rows($sql->setquery('SELECT `sbd` FROM `database_'.$db_id.'` WHERE `hsname` LIKE \'%'.$hsname.'\' AND `class` = \''.$class.'\' AND `sbd` = \''.$sbd.'\'')) <> 0) {			$tpl->set_autoreset();						$db_info = get_db_info($db_id);			$tpl->assign('db_info', $db_info);			$tpl->assign('stt', ++$stt);			$tpl->assign('db_id', $db_id);			$tpl->assign('sbd', $sbd);						$dtb = get_dtb($db_id, $sbd, $hsname, $class);			$tpl->assign('dtb', $dtb);			if ($dtb < 5) {				$tpl->assign('kt_point_type', 'low_point');			} elseif ($dtb >= 8) {				$tpl->assign('kt_point_type', 'high_point');			} else {				$tpl->assign('kt_point_type', '');			}						$tpl->parse('main.output.hs_point');			$chart[$db_info] = $dtb;		}	}			$year_dtb = 0;	foreach ($chart as $info => $val) {		$year_dtb = $year_dtb + $val;	}		$year_dtb = number_format($year_dtb / count($chart), 2);	$tpl->assign('year_point_db', $year_dtb);	if ($year_dtb < 5) {		$tpl->assign('year_point_type', 'low_point');	} elseif ($year_dtb >= 8) {		$tpl->assign('year_point_type', 'high_point');	}		$tpl->assign('fb_link', SITE.'link.php?link='.base64_encode($_SERVER['REQUEST_URI']));	$tpl->assign('fb_title', 'PHPPV - Xem kết quả học tập');	$tpl->assign('fb_descr', 'Tên học sinh: '.standard_name($hsname).', Lớp: '.$class.', Số báo danh: '.$sbd.', Năm học: '.$year);		$tpl->parse('main.output');		$chart['Điểm trung bình cả năm'] = $year_dtb;	$_SESSION['chart'] = $chart;		}function export_hs_list($data) {	global $sql, $tpl, $year;		foreach ($data as $stt => $hs_info) {		$tpl->set_autoreset();				$tpl->assign('stt', $stt+1);		$tpl->assign('sbd', $hs_info['sbd']);		$tpl->assign('hsname', standard_name($hs_info['hsname']));		$tpl->assign('class', $hs_info['class']);		$tpl->assign('year', $year);				$tpl->parse('main.hs_list.hs');			}		$tpl->parse('main.hs_list');}	function search_hs($sbd, $hsname, $class) {	global $sql, $year;		$db_list = get_db_list($year);		$query_class = ($class == null) ? null : ' AND `class` = \''.$class.'\'';	$query_sbd = ($sbd == null) ? null : ' AND `sbd` = '.$sbd;		$i = 0;	foreach ($db_list as $db_id) {				$search = $sql->setquery('SELECT * FROM `database_'.$db_id.'` WHERE `hsname` LIKE \'%'.$hsname.'\''.$query_class.$query_sbd);				if (mysql_num_rows($search) <> 0) {			while ($result = mysql_fetch_assoc($search)) {				$data[$i]['sbd'] = $result['sbd'];				$data[$i]['hsname'] = $result['hsname'];				$data[$i]['class'] = $result['class'];								$i++;			}		}	}		//array_unique not support array	$cache = array();	for ($i = 0; $i <= (count($data)-1); $i++) {		if (!in_array($data[$i], $cache)) {			$cache[] = $data[$i];		}	}		return $cache;}?>